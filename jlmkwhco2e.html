<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源數據面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1a202c;
        }

        .number-display {
            font-family: monospace;
            font-size: 2.5rem;
            font-weight: 700;
        }

        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                color: #1a202c; /* 文字顏色改為黑色 */
                box-shadow: 0 0px 10px rgba(0, 0, 0, 0.1);
            }

            50% {
                transform: scale(1.05);
                color: #059669; /* 文字顏色改為更深的綠色 */
                box-shadow: 0 0px 20px rgba(5, 150, 105, 0.5); /* 陰影顏色改為更深的綠色 */
            }
        }

        .breathe-animation {
            animation: breathe 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="data-container" class="w-full max-w-4xl p-8 bg-gray-100 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">能源數據即時顯示</h1>

        <!-- 移除載入中訊息 -->

        <div id="data-panel" class="flex flex-col md:flex-row items-center justify-around space-y-8 md:space-y-0 md:space-x-8 text-center">
            <!-- 總用電量區塊 -->
            <div id="kwh-card" class="flex-1 flex flex-col items-center justify-center w-48 h-48 bg-gray-200 rounded-full shadow-lg">
                <span class="text-xl font-medium text-gray-600">總用電量</span>
                <div class="mt-2">
                    <span id="kwh-value" class="number-display">0</span>
                    <span class="text-base text-gray-500 font-medium"> Kwh</span>
                </div>
            </div>

            <!-- 分隔線 -->
            <div class="hidden md:block w-1 h-24 bg-gray-400 rounded-full"></div>
            <div class="block md:hidden w-24 h-1 bg-gray-400 rounded-full"></div>

            <!-- 總碳排量區塊 -->
            <div id="co2e-card" class="flex-1 flex flex-col items-center justify-center w-48 h-48 bg-gray-200 rounded-full shadow-lg">
                <span class="text-xl font-medium text-gray-600">總碳排量</span>
                <div class="mt-2">
                    <span id="co2e-value" class="number-display">0</span>
                    <span class="text-base text-gray-500 font-medium"> KgCo2e</span>
                </div>
            </div>
        </div>

        <div id="error-message" class="hidden text-center text-lg text-red-500 mt-8">
            無法載入資料。請檢查 API 伺服器或網路連線。
        </div>
    </div>

    <script>
        // API 網址與碳排放係數
        const API_URL = 'https://jlm-co2e-db-connect-221081318298.asia-east1.run.app/api/get_total_latest_kwh';
        const CO2E_FACTOR = 0.495; // 碳排係數: KgCo2e/Kwh

        // 獲取 DOM 元素
        const kwhValueEl = document.getElementById('kwh-value');
        const co2eValueEl = document.getElementById('co2e-value');
        const kwhCardEl = document.getElementById('kwh-card');
        const co2eCardEl = document.getElementById('co2e-card');
        const dataPanelEl = document.getElementById('data-panel');
        const errorEl = document.getElementById('error-message');

        // 數字平滑滾動動畫函式
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = start + progress * (end - start);
                obj.textContent = Math.round(currentValue).toLocaleString(); // 四捨五入並加入千分位
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.textContent = Math.round(end).toLocaleString();
                }
            };
            window.requestAnimationFrame(step);
        }

        // 獲取數據並啟動動畫
        async function fetchData() {
            dataPanelEl.classList.remove('hidden');
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }
                const data = await response.json();

                // Log the entire data object to the console for debugging
                console.log('API 回傳的資料:', data);

                // Correcting the key to match the user's working version
                const totalKwh = data.total_kwh || 0;
                const totalCo2e = (totalKwh * CO2E_FACTOR).toFixed(2);

                // 啟動動畫
                animateValue(kwhValueEl, 0, totalKwh, 3000);
                animateValue(co2eValueEl, 0, Math.round(totalCo2e), 3000); // 碳排量四捨五入到整數

                // 應用呼吸動畫效果到整個卡片區塊
                kwhCardEl.classList.add('breathe-animation');
                co2eCardEl.classList.add('breathe-animation');

            } catch (error) {
                console.error('獲取數據時發生錯誤:', error);
                errorEl.classList.remove('hidden');
            }
        }

        // 在頁面載入時執行
        window.onload = fetchData;
    </script>

</body>
</html>
