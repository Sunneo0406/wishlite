<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESP32 遊戲中心</title>
    <style>
        :root {
            --gamepad-bg: #404040; --button-bg: #2c2c2c; --text-color: #e0e0e0;
            --red: #e53935; --green: #43a047; --blue: #1e88e5; --yellow: #fdd835;
        }
        body {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            margin: 0; background-color: #212121; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color); flex-direction: column; -webkit-user-select: none;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .main-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .info-panel { text-align: center; margin-bottom: 2rem; min-height: 3em; }
        h1 { margin: 0 0 0.5rem 0; font-weight: 300; }
        #status { font-size: 1em; color: #bdbdbd; }
        .gamepad-body {
            display: none; /* 改為預設隱藏 */
            justify-content: space-between; align-items: center; width: 90vw; max-width: 600px;
            height: 250px; background: linear-gradient(145deg, #454545, #3a3a3a);
            border-radius: 20px; padding: 20px 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.1);
            border: 2px solid #282828;
        }
        /* vvvvvvvvvv 新增遊戲選擇畫面樣式 vvvvvvvvvv */
        #game-selection {
            display: none; /* 預設隱藏 */
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 2rem;
        }
        #game-selection h2 {
            font-weight: 300;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        .game-btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 200px;
            box-shadow: 0 5px 8px rgba(0,0,0,0.25);
            transition: all 0.1s ease-out;
        }
        .game-btn:hover { background: #1579c9; }
        .game-btn:active { transform: translateY(2px) scale(0.98); }
        /* ^^^^^^^^^^ 結束新增樣式 ^^^^^^^^^^ */

        .button {
            border: none; cursor: pointer;
            box-shadow: 0 5px 8px rgba(0,0,0,0.25), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.08s ease-out;
        }
        .button:active, .button.active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 2px 3px rgba(0,0,0,0.3);
        }
        .d-pad, .action-buttons, #btn-pause { display: none; }
        .d-pad { position: relative; width: 150px; height: 150px; }
        .d-pad .button { position: absolute; width: 50px; height: 50px; background-color: var(--button-bg); color: #999; font-size: 28px; line-height: 50px; text-align: center; }
        #btn-up { top: 0; left: 50px; border-radius: 8px 8px 0 0; }
        #btn-down { bottom: 0; left: 50px; border-radius: 0 0 8px 8px; }
        #btn-left { top: 50px; left: 0; border-radius: 8px 0 0 8px; }
        #btn-right { top: 50px; right: 0; border-radius: 0 8px 8px 0; }
        .d-pad::after { content: ''; position: absolute; top: 50px; left: 50px; width: 50px; height: 50px; background: #333; box-shadow: inset 0 3px 5px rgba(0,0,0,0.4); }
        .center-controls { display: flex; flex-direction: row; gap: 15px; }
        .center-controls .button { width: 80px; height: 30px; border-radius: 15px; background-color: #222; color: var(--text-color); font-size: 14px; font-weight: bold; }
        #btn-connect { background: var(--blue); }
        .action-buttons { position: relative; width: 150px; height: 150px; }
        .action-buttons .button { position: absolute; width: 55px; height: 55px; border-radius: 50%; color: white; font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #btn-y { top: 0; left: 47.5px; background-color: var(--yellow); color: #555; }
        #btn-b { bottom: 0; left: 47.5px; background-color: var(--red); }
        #btn-x { top: 47.5px; left: 0; background-color: var(--blue); }
        #btn-a { top: 47.5px; right: 0; background-color: var(--green); }
        #fullscreen-lock-btn { display: none; margin-bottom: 1rem; padding: 8px 16px; font-size: 1em; font-weight: bold; color: white; background-color: #0275d8; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #orientation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #212121; z-index: 9999; display: none; justify-content: center; align-items: center; text-align: center; color: #fff; }
        #orientation-overlay .message { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        #orientation-overlay p { font-size: 1.2rem; line-height: 1.5; }
        @media (max-width: 768px) { #fullscreen-lock-btn { display: inline-block; } }
        @media (orientation: portrait) and (max-width: 800px) { .main-container { display: none; } #orientation-overlay { display: flex; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="info-panel">
            <h1>ESP32 遊戲中心</h1>
            <button id="fullscreen-lock-btn" class="show-on-mobile">橫向全螢幕</button>
            <div id="score-board" style="display: none; margin-top: 1rem;">
                <span style="margin: 0 10px;">分數: <b id="score">0</b></span>
                <span style="margin: 0 10px;">等級: <b id="level">1</b></span>
                <span style="margin: 0 10px;">行數: <b id="lines">0</b></span>
            </div>
            <p id="status">請點擊「連線」按鈕開始</p>
        </div>

        <div id="game-selection">
            <h2>選擇一個遊戲</h2>
            <button class="game-btn" id="btn-select-tetris">俄羅斯方塊</button>
            <button class="game-btn" id="btn-select-snake">貪吃蛇</button>
        </div>
        <div class="gamepad-body" >
            <div class="d-pad">
                <button class="button" id="btn-up" title="上 (W/↑)">▲</button>
                <button class="button" id="btn-left" title="左 (A/←)">◄</button>
                <button class="button" id="btn-right" title="右 (D/→)">►</button>
                <button class="button" id="btn-down" title="下 (S/↓)">▼</button>
            </div>
            <div class="center-controls">
                <button class="button" id="btn-connect">連線</button>
                <button class="button" id="btn-pause">暫停</button>
            </div>
            <div class="action-buttons">
                <button class="button" id="btn-y" title="預留 (Y)">Y</button>
                <button class="button" id="btn-x" title="加速下降 (X)">X</button>
                <button class="button" id="btn-b" title="重新開始/返回 (B)">B</button>
                <button class="button" id="btn-a" title="旋轉 (Space)">A</button>
            </div>
        </div>
    </div>
    <div id="orientation-overlay"> </div>

    <script>
        const elements = {
            status: document.getElementById('status'),
            connectBtn: document.getElementById('btn-connect'),
            pauseBtn: document.getElementById('btn-pause'),
            fullscreenBtn: document.getElementById('fullscreen-lock-btn'),
            gamepadBody: document.querySelector('.gamepad-body'),
            gameSelection: document.getElementById('game-selection'),
            dPad: document.querySelector('.d-pad'),
            actionButtons: document.querySelector('.action-buttons'),
            scoreBoard: document.getElementById('score-board'),
            scoreDisplay: document.getElementById('score'),
            levelDisplay: document.getElementById('level'),
            linesDisplay: document.getElementById('lines'),
            buttons: {
                up: document.getElementById('btn-up'), down: document.getElementById('btn-down'),
                left: document.getElementById('btn-left'), right: document.getElementById('btn-right'),
                a: document.getElementById('btn-a'), b: document.getElementById('btn-b'),
                x: document.getElementById('btn-x'), y: document.getElementById('btn-y'),
                selectTetris: document.getElementById('btn-select-tetris'),
                selectSnake: document.getElementById('btn-select-snake'),
            }
        };

        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const GAME_STATE_CHAR_UUID = "1e62136e-3907-4258-9ca3-a4f21a5301a2";
        let gameCharacteristic;
        let gameStateCharacteristic;

        // --- 指令碼更新 ---
        const COMMANDS = {
            LEFT: 0x01, RIGHT: 0x02, UP: 0x03, DOWN: 0x04,
            ACTION_A: 0x05, ACTION_B: 0x06, PAUSE: 0x07,
            SOFT_DROP_START: 0x08, SOFT_DROP_END: 0x09,
            SELECT_GAME: 0x10
        };
        const GAMES = {
            TETRIS: 0x01, SNAKE: 0x02
        };

        elements.connectBtn.addEventListener('click', async () => {
            // ... 連線邏輯不變 ...
            try {
                // ...
                await gameStateCharacteristic.startNotifications();
                gameStateCharacteristic.addEventListener('characteristicvaluechanged', handleGameStateUpdate);

                elements.status.textContent = '✅ 連接成功！請選擇一個遊戲。';
                elements.connectBtn.style.display = 'none';
                elements.gameSelection.style.display = 'flex'; // 顯示遊戲選擇畫面

            } catch (error) {
                // ... 錯誤處理不變 ...
            }
        });
        
        async function sendCommand(command, value = null) {
            if (!gameCharacteristic) return;
            try {
                let data;
                if (value !== null) {
                    data = new Uint8Array([command, value]); // 帶參數的指令
                } else {
                    data = new Uint8Array([command]); // 無參數指令
                }
                await gameCharacteristic.writeValueWithoutResponse(data);
            } catch (error) { console.error('指令發送失敗:', error); }
        }

        // --- 遊戲選擇邏輯 ---
        elements.buttons.selectTetris.addEventListener('click', () => selectGame(GAMES.TETRIS));
        elements.buttons.selectSnake.addEventListener('click', () => selectGame(GAMES.SNAKE));
        
        function selectGame(gameId) {
            sendCommand(COMMANDS.SELECT_GAME, gameId);
            elements.gameSelection.style.display = 'none';
            elements.gamepadBody.style.display = 'flex';
            elements.scoreBoard.style.display = 'block';

            // 根據遊戲顯示對應的控制器
            if (gameId === GAMES.TETRIS) {
                elements.dPad.style.display = 'block';
                elements.actionButtons.style.display = 'block';
                elements.pauseBtn.style.display = 'block';
                elements.buttons.up.title = "瞬降 (W/↑)";
                elements.buttons.down.title = "緩降 (S/↓)";
                elements.buttons.a.title = "旋轉 (Space)";
                elements.buttons.b.title = "重新開始 (B)";
            } else if (gameId === GAMES.SNAKE) {
                elements.dPad.style.display = 'block';
                elements.actionButtons.style.display = 'none'; // 貪吃蛇不需要 A,B,X,Y
                elements.pauseBtn.style.display = 'block';
                elements.buttons.up.title = "上 (W/↑)";
                elements.buttons.down.title = "下 (S/↓)";
                // B按鈕重新利用為返回遊戲選擇畫面
                const restartBtn = document.createElement('button');
                restartBtn.className = 'button';
                restartBtn.textContent = '返回';
                restartBtn.style.backgroundColor = 'var(--red)';
                restartBtn.style.color = 'white';
                restartBtn.addEventListener('pointerdown', () => sendCommand(COMMANDS.ACTION_B));
                elements.actionButtons.innerHTML = '';
                elements.actionButtons.appendChild(restartBtn);
                elements.actionButtons.style.display = 'block';
            }
        }

        // --- 按鈕和鍵盤映射更新 ---
        const buttonActions = [
            { el: elements.buttons.left,  cmd: COMMANDS.LEFT },
            { el: elements.buttons.right, cmd: COMMANDS.RIGHT },
            { el: elements.buttons.up,    cmd: COMMANDS.UP }, // 原本是預留，現在改為 UP
            { el: elements.buttons.a,     cmd: COMMANDS.ACTION_A },
            { el: elements.buttons.b,     cmd: COMMANDS.ACTION_B },
            { el: elements.pauseBtn,      cmd: COMMANDS.PAUSE },
        ];
        
        buttonActions.forEach(action => {
            action.el.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(action.cmd); });
        });

        const softDropButtons = [elements.buttons.down, elements.buttons.x]; // x 鍵保留給俄羅斯方塊
        softDropButtons.forEach(btn => {
            btn.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.DOWN); }); // 直接發送 DOWN
        });

        const keyMap = {
            'arrowleft':  { el: elements.buttons.left,  cmd: COMMANDS.LEFT }, 'a': { el: elements.buttons.left,  cmd: COMMANDS.LEFT },
            'arrowright': { el: elements.buttons.right, cmd: COMMANDS.RIGHT },'d': { el: elements.buttons.right, cmd: COMMANDS.RIGHT },
            'arrowup':    { el: elements.buttons.up,    cmd: COMMANDS.UP },   'w': { el: elements.buttons.up,    cmd: COMMANDS.UP },
            'arrowdown':  { el: elements.buttons.down,  cmd: COMMANDS.DOWN }, 's': { el: elements.buttons.down,  cmd: COMMANDS.DOWN },
            ' ':          { el: elements.buttons.a,     cmd: COMMANDS.ACTION_A },
            'b':          { el: elements.buttons.b,     cmd: COMMANDS.ACTION_B },
            'p':          { el: elements.pauseBtn,      cmd: COMMANDS.PAUSE },
        };

        window.addEventListener('keydown', e => {
            const key = e.key.toLowerCase(); const action = keyMap[key];
            if (action && !e.repeat) { e.preventDefault(); sendCommand(action.cmd); action.el.classList.add('active'); }
        });
        window.addEventListener('keyup', e => {
            const key = e.key.toLowerCase(); const action = keyMap[key];
            if (action) { action.el.classList.remove('active'); }
        });

        // ... 全螢幕和遊戲狀態更新邏輯不變 ...
        function handleGameStateUpdate(event) {
            // ... 內容不變 ...
        }
    </script>
</body>
</html>