<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESP32 遊戲手把</title>
    <style>
        :root {
            --gamepad-bg: #404040;
            --button-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --red: #e53935;
            --green: #43a047;
            --blue: #1e88e5;
            --yellow: #fdd835;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #212121;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color);
            flex-direction: column;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 主要佈局與資訊面板 --- */
        .main-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-panel {
            text-align: center;
            margin-bottom: 2rem;
            min-height: 3em;
        }

        h1 {
            margin: 0 0 0.5rem 0;
            font-weight: 300;
        }
        
        #status {
            font-size: 1em;
            color: #bdbdbd;
        }

        /* --- 遊戲手把主體 --- */
        .gamepad-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90vw;
            max-width: 600px;
            height: 250px;
            background: linear-gradient(145deg, #454545, #3a3a3a);
            border-radius: 20px;
            padding: 20px 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.1);
            border: 2px solid #282828;
        }

        .button {
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 8px rgba(0,0,0,0.25), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.08s ease-out;
        }
        .button:active, .button.active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 2px 3px rgba(0,0,0,0.3);
        }
        
        /* --- 遊戲按鈕初始狀態 --- */
        .d-pad, .action-buttons, #btn-pause {
            display: none;
        }

        /* --- 左側：十字鍵 (D-Pad) --- */
        .d-pad {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .d-pad .button {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: var(--button-bg);
            color: #999;
            font-size: 28px;
            line-height: 50px;
            text-align: center;
        }
        #btn-up { top: 0; left: 50px; border-radius: 8px 8px 0 0; }
        #btn-down { bottom: 0; left: 50px; border-radius: 0 0 8px 8px; }
        #btn-left { top: 50px; left: 0; border-radius: 8px 0 0 8px; }
        #btn-right { top: 50px; right: 0; border-radius: 0 8px 8px 0; }
        .d-pad::after {
            content: ''; position: absolute; top: 50px; left: 50px;
            width: 50px; height: 50px; background: #333;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.4);
        }

        /* --- 中間：控制按鈕 --- */
        .center-controls {
            display: flex;
            flex-direction: row;
            gap: 15px;
        }
        .center-controls .button {
            width: 80px;
            height: 30px;
            border-radius: 15px;
            background-color: #222;
            color: var(--text-color);
            font-size: 14px;
            font-weight: bold;
        }
        #btn-connect { background: var(--blue); }

        /* --- 右側：動作按鈕 (A,B,X,Y) --- */
        .action-buttons {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .action-buttons .button {
            position: absolute; width: 55px; height: 55px;
            border-radius: 50%; color: white; font-size: 20px;
            font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #btn-y { top: 0; left: 47.5px; background-color: var(--yellow); color: #555;}
        #btn-b { bottom: 0; left: 47.5px; background-color: var(--red); }
        #btn-x { top: 47.5px; left: 0; background-color: var(--blue); }
        #btn-a { top: 47.5px; right: 0; background-color: var(--green); }

        /* --- 手機版專用按鈕 --- */
        #fullscreen-lock-btn {
            display: none;
            margin-bottom: 1rem; padding: 8px 16px; font-size: 1em;
            font-weight: bold; color: white; background-color: #0275d8;
            border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
        }
        #fullscreen-lock-btn:hover { background-color: #025aa5; }

        /* --- 橫向提示層 --- */
        #orientation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #212121; z-index: 9999; display: none;
            justify-content: center; align-items: center; text-align: center; color: #fff;
        }
        #orientation-overlay .message {
            display: flex; flex-direction: column; align-items: center; gap: 1rem;
        }
        #orientation-overlay p { font-size: 1.2rem; line-height: 1.5; }

        /* --- 響應式與手機版修正 --- */
        @media (max-width: 768px) {
            #fullscreen-lock-btn { display: inline-block; }
        }

        @media (orientation: portrait) and (max-width: 800px) {
            .main-container { display: none; }
            #orientation-overlay { display: flex; }
        }
        
        /* 解決在舊版響應式垂直排列時，D-Pad壓縮的問題 */
        @media (max-width: 650px) and (orientation: portrait) {
            .gamepad-body {
                flex-direction: column; height: auto; width: 85vw;
                padding: 30px 15px; gap: 20px;
            }
            .d-pad { width: 120px; height: 120px; }
            .d-pad .button {
                width: 40px; height: 40px; font-size: 24px; line-height: 40px;
                display: flex; justify-content: center; align-items: center; padding: 0;
            }
            #btn-up { top: 0; left: 40px; }
            #btn-down { bottom: 0; left: 40px; }
            #btn-left { top: 40px; left: 0; }
            #btn-right { top: 40px; right: 0; }
            .d-pad::after { top: 40px; left: 40px; width: 40px; height: 40px; }
        }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="info-panel">
            <h1>ESP32 無線控制器</h1>
            <button id="fullscreen-lock-btn" class="show-on-mobile">橫向全螢幕</button>
            <p id="status">請點擊手把中央的「連線」按鈕</p>
        </div>

        <div class="gamepad-body" >
            <div class="d-pad" style="display: block;">
                <button class="button" id="btn-up" title="預留 (W/↑)">▲</button>
                <button class="button" id="btn-left" title="左 (A/←)">◄</button>
                <button class="button" id="btn-right" title="右 (D/→)">►</button>
                <button class="button" id="btn-down" title="快速下降 (S/↓)">▼</button>
            </div>

            <div class="center-controls" style="display: block flex;">
                <button class="button" id="btn-connect">連線</button>
                <button class="button" id="btn-pause" style="display: block;">暫停</button>
            </div>

            <div class="action-buttons" style="display: block;">
                <button class="button" id="btn-y" title="預留 (Y)">Y</button>
                <button class="button" id="btn-x" title="快速下降 (X)">X</button>
                <button class="button" id="btn-b" title="預留 (B)">B</button>
                <button class="button" id="btn-a" title="旋轉 (A/Space)">A</button>
            </div>
        </div>
    </div>

    <div id="orientation-overlay">
        <div class="message">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 13.84V10.16a1.68 1.68 0 0 1 1.68-1.68h15.64a1.68 1.68 0 0 1 1.68 1.68v3.68a1.68 1.68 0 0 1-1.68-1.68H4.18a1.68 1.68 0 0 1-1.68-1.68zM17 19.5h-10c-1.1 0-2-.9-2-2v-1.65a2.29 2.29 0 0 1 2.29-2.29h9.42a2.29 2.29 0 0 1 2.29 2.29V17.5c0 1.1-.9 2-2 2z"></path></svg>
            <p>為了獲得最佳體驗<br>請將您的手機轉為橫向</p>
        </div>
    </div>

    <script>
        // --- 元素節點 ---
        const elements = {
            status: document.getElementById('status'),
            connectBtn: document.getElementById('btn-connect'),
            pauseBtn: document.getElementById('btn-pause'),
            fullscreenBtn: document.getElementById('fullscreen-lock-btn'),
            dPad: document.querySelector('.d-pad'),
            actionButtons: document.querySelector('.action-buttons'),
            buttons: {
                up: document.getElementById('btn-up'), down: document.getElementById('btn-down'),
                left: document.getElementById('btn-left'), right: document.getElementById('btn-right'),
                a: document.getElementById('btn-a'), b: document.getElementById('btn-b'),
                x: document.getElementById('btn-x'), y: document.getElementById('btn-y'),
            }
        };

        // --- 藍牙設定 ---
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        let gameCharacteristic;

        // --- 指令碼 ---
        const COMMANDS = {
            LEFT: 0x01, RIGHT: 0x02, ROTATE: 0x03, FAST_DROP: 0x04, PAUSE: 0x05,
        };

        // --- 連接藍牙 ---
        elements.connectBtn.addEventListener('click', async () => {
            if (!navigator.bluetooth) {
                elements.status.textContent = '錯誤: 您的瀏覽器不支援 Web Bluetooth！'; return;
            }
            try {
                elements.status.textContent = '正在掃描藍牙裝置...';
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                });
                elements.status.textContent = '正在連接裝置...';
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                gameCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                elements.status.textContent = '✅ 連接成功！可以開始遊戲了！';
                elements.connectBtn.style.display = 'none';
                elements.pauseBtn.style.display = 'block';
                elements.dPad.style.display = 'block';
                elements.actionButtons.style.display = 'block';
            } catch(error) {
                console.error('連線失敗:', error);
                elements.status.textContent = `❌ 連線失敗: ${error.message}`;
            }
        });
        
        // --- 發送指令函式 ---
        async function sendCommand(command) {
            if (!gameCharacteristic) return;
            try {
                await gameCharacteristic.writeValueWithoutResponse(new Uint8Array([command]));
            } catch (error) { console.error('指令發送失敗:', error); }
        }

        // --- 按鈕與指令的映射 ---
        const buttonActions = [
            { el: elements.buttons.left,  cmd: COMMANDS.LEFT }, { el: elements.buttons.right, cmd: COMMANDS.RIGHT },
            { el: elements.buttons.down,  cmd: COMMANDS.FAST_DROP }, { el: elements.buttons.a, cmd: COMMANDS.ROTATE },
            { el: elements.buttons.x,     cmd: COMMANDS.FAST_DROP }, { el: elements.pauseBtn, cmd: COMMANDS.PAUSE },
        ];
        // 使用 pointerdown 事件來統一處理滑鼠與觸控，避免重複觸發
        buttonActions.forEach(action => {
            action.el.addEventListener('pointerdown', (e) => {
                e.preventDefault(); // 防止觸控時觸發頁面滾動或縮放等預設行為
                sendCommand(action.cmd);
            });
        });

        // --- 鍵盤支援 ---
        const keyMap = {
            'arrowleft': { el: elements.buttons.left, cmd: COMMANDS.LEFT }, 'a': { el: elements.buttons.left, cmd: COMMANDS.LEFT },
            'arrowright': { el: elements.buttons.right, cmd: COMMANDS.RIGHT }, 'd': { el: elements.buttons.right, cmd: COMMANDS.RIGHT },
            'arrowdown': { el: elements.buttons.down, cmd: COMMANDS.FAST_DROP }, 's': { el: elements.buttons.down, cmd: COMMANDS.FAST_DROP },
            'x': { el: elements.buttons.x, cmd: COMMANDS.FAST_DROP },
            'arrowup': { el: elements.buttons.a, cmd: COMMANDS.ROTATE }, 'w': { el: elements.buttons.a, cmd: COMMANDS.ROTATE },
            ' ': { el: elements.buttons.a, cmd: COMMANDS.ROTATE }, 'p': { el: elements.pauseBtn, cmd: COMMANDS.PAUSE },
        };
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase(); const action = keyMap[key];
            if (action && !e.repeat) { e.preventDefault(); sendCommand(action.cmd); action.el.classList.add('active'); }
        });
        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase(); const action = keyMap[key];
            if (action) { action.el.classList.remove('active'); }
        });

        // --- 全螢幕與鎖定方向 ---
        if (elements.fullscreenBtn) {
            elements.fullscreenBtn.addEventListener('click', async () => {
                if (!document.documentElement.requestFullscreen) { elements.status.textContent = '您的瀏覽器不支援全螢幕'; return; }
                try {
                    await document.documentElement.requestFullscreen();
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape');
                        elements.status.textContent = '成功鎖定為橫向';
                    } else { elements.status.textContent = '已進入全螢幕'; }
                } catch (error) { console.error('操作失敗:', error); elements.status.textContent = '操作失敗，您可能已取消請求'; }
            });
        }
    </script>
</body>
</html>