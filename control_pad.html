<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éŠæˆ²ä¸­å¿ƒ</title>
    <style>
        :root {
            --gamepad-bg: #404040; --button-bg: #2c2c2c; --text-color: #e0e0e0;
            --red: #e53935; --green: #43a047; --blue: #1e88e5; --yellow: #fdd835;
            /* <<< [ä¿®æ”¹] ä½¿ç”¨ vmin ä¾†å®šç¾©å°ºå¯¸ï¼Œè®“ä»‹é¢èƒ½ä¾è¢å¹•å¤§å°ç¸®æ”¾ */
            --base-size: 25vmin;
            --button-size: calc(var(--base-size) / 3);
            --action-button-size: calc(var(--base-size) / 2.8);
        }
        body {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            margin: 0; background-color: #212121; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color); flex-direction: column; -webkit-user-select: none;
            user-select: none; -webkit-tap-highlight-color: transparent;
            /*overflow: hidden; /* é˜²æ­¢åœ¨å°è¢å¹•ä¸Šæ»¾å‹• */
        }
        .main-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .info-panel { text-align: center; margin-bottom: 2vh; min-height: 5em; }
        /* <<< [ä¿®æ”¹] å°‡åœ–ç‰‡æ¨£å¼ç§»åˆ° CSS ä¸­ */
        .info-panel img {
            width: 40%;
            /*max-width: 400px; /* é™åˆ¶åœ–ç‰‡æœ€å¤§å¯¬åº¦ */
            height: auto;
            margin-bottom: 1rem;
        }
        h1 { margin: 0 0 0.5rem 0; font-weight: 300; }
        #status { font-size: 1em; color: #bdbdbd; }
        #volume-control, #brightness-control {
            display: none; align-items: center; justify-content: center; margin-top: 1rem; color: #ccc;
        }
        #volume-slider, #brightness-slider {
            -webkit-appearance: none; width: 150px; height: 8px; background: #555;
            outline: none; border-radius: 4px; margin: 0 10px;
        }
        #volume-slider::-webkit-slider-thumb, #brightness-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: var(--blue); cursor: pointer; border-radius: 50%;
        }
        #volume-slider::-moz-range-thumb, #brightness-slider::-moz-range-thumb {
            width: 20px; height: 20px; background: var(--blue); cursor: pointer; border-radius: 50%;
        }
        /* <<< [ä¿®æ”¹] ä¸»è¦ä¿®æ”¹å€åŸŸï¼Œä½¿ç”¨è®Šæ•¸å’Œ vmin */
        .gamepad-body {
            display: flex; justify-content: space-between; align-items: center;
            width: 90vw; max-width: 800px; /* å¢åŠ æœ€å¤§å¯¬åº¦ä»¥é©æ‡‰å¹³æ¿ */
            height: calc(var(--base-size) + 40px);
            background: linear-gradient(145deg, #454545, #3a3a3a);
            border-radius: 20px; padding: 20px 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.1);
            border: 2px solid #282828;
        }
        #game-selection {
            display: none; flex-direction: column; align-items: center;
            gap: 20px; margin-top: 2rem;
        }
        #game-selection h2 {
            font-weight: 300; border-bottom: 1px solid #555; padding-bottom: 10px;
        }
        .game-btn {
            background: var(--blue); color: white; border: none; padding: 15px 30px;
            font-size: 1.2em; font-weight: bold; border-radius: 10px; cursor: pointer;
            width: 200px; box-shadow: 0 5px 8px rgba(0,0,0,0.25); transition: all 0.1s ease-out;
        }
        .button {
            border: none; cursor: pointer;
            box-shadow: 0 5px 8px rgba(0,0,0,0.25), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.08s ease-out;
        }
        .button:active, .button.active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 2px 3px rgba(0,0,0,0.3);
        }
        .d-pad, .action-buttons, #btn-pause, #btn-return { display: none; }
        .d-pad, .action-buttons {
            position: relative;
            width: var(--base-size);
            height: var(--base-size);
        }
        .d-pad .button {
            position: absolute;
            width: var(--button-size);
            height: var(--button-size);
            background-color: var(--button-bg); color: #999;
            font-size: calc(var(--button-size) * 0.6);
            line-height: var(--button-size);
            text-align: center;
        }
        #btn-up { top: 0; left: var(--button-size); border-radius: 8px 8px 0 0; }
        #btn-down { bottom: 0; left: var(--button-size); border-radius: 0 0 8px 8px; }
        #btn-left { top: var(--button-size); left: 0; border-radius: 8px 0 0 8px; }
        #btn-right { top: var(--button-size); right: 0; border-radius: 0 8px 8px 0; }
        .d-pad::after {
            content: ''; position: absolute;
            top: var(--button-size); left: var(--button-size);
            width: var(--button-size); height: var(--button-size);
            background: #333; box-shadow: inset 0 3px 5px rgba(0,0,0,0.4);
        }
        .center-controls { display: flex; flex-direction: row; gap: 15px; align-items: center;}
        .center-controls .button {
            width: calc(var(--base-size) * 0.8);
            height: calc(var(--base-size) * 0.3);
            border-radius: 15px; background-color: #222; color: var(--text-color);
            font-size: calc(var(--base-size) * 0.15); font-weight: bold;
        }
        #btn-connect { background: var(--blue); }
        #btn-return { background-color: var(--red); }
        .action-buttons .button {
            position: absolute;
            width: var(--action-button-size); height: var(--action-button-size);
            border-radius: 50%; color: white;
            font-size: calc(var(--action-button-size) * 0.4);
            font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #btn-y { top: 0; left: calc(50% - var(--action-button-size) / 2); background-color: var(--yellow); color: #555; }
        #btn-b { bottom: 0; left: calc(50% - var(--action-button-size) / 2); background-color: var(--red); }
        #btn-x { top: calc(50% - var(--action-button-size) / 2); left: 0; background-color: var(--blue); }
        #btn-a { top: calc(50% - var(--action-button-size) / 2); right: 0; background-color: var(--green); }

        /* <<< [æ–°å¢] Media Query é©æ‡‰å°è¢å¹•ï¼Œä¾‹å¦‚æ‰‹æ©Ÿæ©«å‘æ¨¡å¼ */
        @media (max-height: 450px) {
            :root {
                --base-size: 22vh;
            }
            .info-panel {
                margin-bottom: 1vh;
            }
            .info-panel img {
                display: none; /* åœ¨å¾ˆæ‰çš„è¢å¹•ä¸Šéš±è—åœ–ç‰‡ */
            }
        }
        @media (max-width: 380px) {
            .center-controls .button {
                font-size: calc(var(--base-size) * 0.12); /* åœ¨å¾ˆçª„çš„è¢å¹•ä¸Šç¸®å°å­—é«” */
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="info-panel">
            <img src="img/03.png" alt="ESP32 Game Center Logo"> <div id="score-board" style="display: none; margin-top: 1rem;">
                <span style="margin: 0 10px;">åˆ†æ•¸: <b id="score">0</b></span>
                <span style="margin: 0 10px;">ç­‰ç´š: <b id="level">1</b></span>
                <span style="margin: 0 10px;">è¡Œæ•¸: <b id="lines">0</b></span>
            </div>
            <p id="status">è«‹é»æ“Šã€Œé€£ç·šã€æŒ‰éˆ•é–‹å§‹</p>

            <div id="volume-control">
                <span>ğŸ”ˆ</span>
                <input type="range" id="volume-slider" min="0" max="30" value="25">
                <span>ğŸ”Š</span>
            </div>
            <div id="brightness-control">
                <span>ğŸ”…</span>
                <input type="range" id="brightness-slider" min="10" max="255" value="30">
                <span>ğŸ”†</span>
            </div>
        </div>

        <div id="game-selection">
            <h2>é¸æ“‡ä¸€å€‹éŠæˆ²</h2>
            <button class="game-btn" id="btn-select-tetris">ä¿„ç¾…æ–¯æ–¹å¡Š</button>
            <button class="game-btn" id="btn-select-snake">è²ªåƒè›‡</button>
            <button class="game-btn" id="btn-select-dino">å°æé¾è·³èº</button>
        </div>

        <div class="gamepad-body">
            <div class="d-pad">
                <button class="button" id="btn-up" title="ä¸Š (W/â†‘)">â–²</button>
                <button class="button" id="btn-left" title="å·¦ (A/â†)">â—„</button>
                <button class="button" id="btn-right" title="å³ (D/â†’)">â–º</button>
                <button class="button" id="btn-down" title="ä¸‹ (S/â†“)">â–¼</button>
            </div>
            <div class="center-controls">
                <button class="button" id="btn-connect">é€£ç·š</button>
                <button class="button" id="btn-return">è¿”å›</button>
                <button class="button" id="btn-pause">æš«åœ</button>
            </div>
            <div class="action-buttons">
                <button class="button" id="btn-y" title="é ç•™ (Y)">Y</button>
                <button class="button" id="btn-x" title="é ç•™ (X)">X</button>
                <button class="button" id="btn-b" title="é‡æ–°é–‹å§‹ (B)">B</button>
                <button class="button" id="btn-a" title="ä¸»è¦å‹•ä½œ">A</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ‚¨çš„ JavaScript ç¨‹å¼ç¢¼ç¶­æŒä¸è®Š ---
        const elements = {
            status: document.getElementById('status'),
            connectBtn: document.getElementById('btn-connect'),
            pauseBtn: document.getElementById('btn-pause'),
            returnBtn: document.getElementById('btn-return'),
            gamepadBody: document.querySelector('.gamepad-body'),
            gameSelection: document.getElementById('game-selection'),
            dPad: document.querySelector('.d-pad'),
            actionButtons: document.querySelector('.action-buttons'),
            scoreBoard: document.getElementById('score-board'),
            scoreDisplay: document.getElementById('score'),
            levelDisplay: document.getElementById('level'),
            linesDisplay: document.getElementById('lines'),
            volumeControl: document.getElementById('volume-control'),
            volumeSlider: document.getElementById('volume-slider'),
            brightnessControl: document.getElementById('brightness-control'),
            brightnessSlider: document.getElementById('brightness-slider'),
            buttons: {
                up: document.getElementById('btn-up'), down: document.getElementById('btn-down'),
                left: document.getElementById('btn-left'), right: document.getElementById('btn-right'),
                a: document.getElementById('btn-a'), b: document.getElementById('btn-b'),
                x: document.getElementById('btn-x'), y: document.getElementById('btn-y'),
                selectTetris: document.getElementById('btn-select-tetris'),
                selectSnake: document.getElementById('btn-select-snake'),
                selectDino: document.getElementById('btn-select-dino'),
            }
        };

        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const GAME_STATE_CHAR_UUID = "1e62136e-3907-4258-9ca3-a4f21a5301a2";
        let gameCharacteristic, gameStateCharacteristic;
        let commandCooldown = false;

        const COMMANDS = {
            LEFT: 0x01, RIGHT: 0x02, UP: 0x03, DOWN: 0x04,
            ACTION_A: 0x05, ACTION_B: 0x06, PAUSE: 0x07,
            SET_VOLUME: 0x08,
            SET_BRIGHTNESS: 0x09,
            RETURN_MENU: 0x0F,
            SELECT_GAME: 0x10
        };
        const GAMES = { TETRIS: 0x01, SNAKE: 0x02, DINO: 0x03 };

        elements.connectBtn.addEventListener('click', async () => {
            try {
                elements.status.textContent = 'è—ç‰™æƒæä¸­...';
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                
                elements.status.textContent = 'æ­£åœ¨é€£æ¥è‡³è£ç½®...';
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                gameCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                gameStateCharacteristic = await service.getCharacteristic(GAME_STATE_CHAR_UUID);
                await gameStateCharacteristic.startNotifications();
                gameStateCharacteristic.addEventListener('characteristicvaluechanged', handleGameStateUpdate);

                device.addEventListener('gattserverdisconnected', onDisconnected);

                elements.status.textContent = 'âœ… é€£æ¥æˆåŠŸï¼è«‹é¸æ“‡ä¸€å€‹éŠæˆ²ã€‚';
                elements.connectBtn.style.display = 'none';
                elements.gamepadBody.style.display = 'none';
                elements.gameSelection.style.display = 'flex';
                elements.volumeControl.style.display = 'flex';
                elements.brightnessControl.style.display = 'flex';
            } catch (error) {
                elements.status.textContent = `âŒ é€£ç·šå¤±æ•—: ${error.message.split(' GATTSERVER:')[0]}`;
                console.error(error);
            }
        });

        function onDisconnected() {
            elements.status.textContent = 'è—ç‰™å·²æ–·ç·šã€‚';
            elements.connectBtn.style.display = 'block';
            elements.gamepadBody.style.display = 'flex';
            elements.gameSelection.style.display = 'none';
            elements.dPad.style.display = 'none';
            elements.actionButtons.style.display = 'none';
            elements.pauseBtn.style.display = 'none';
            elements.returnBtn.style.display = 'none';
            elements.scoreBoard.style.display = 'none';
            elements.volumeControl.style.display = 'none';
            elements.brightnessControl.style.display = 'none';
        }
        
        async function sendCommand(command, value = null) {
            if (!gameCharacteristic) return;
            if (command > COMMANDS.DOWN && commandCooldown) return;

            commandCooldown = true;
            setTimeout(() => { commandCooldown = false; }, 100);

            try {
                let data = (value !== null) ? new Uint8Array([command, value]) : new Uint8Array([command]);
                await gameCharacteristic.writeValueWithoutResponse(data);
            } catch (error) { 
                console.error('æŒ‡ä»¤ç™¼é€å¤±æ•—:', error);
                commandCooldown = false;
            }
        }

        elements.volumeSlider.addEventListener('input', (event) => {
            const volume = parseInt(event.target.value, 10);
            if (!gameCharacteristic) return;
            try {
                let data = new Uint8Array([COMMANDS.SET_VOLUME, volume]);
                gameCharacteristic.writeValueWithoutResponse(data);
            } catch(error) {
                console.error('éŸ³é‡æŒ‡ä»¤ç™¼é€å¤±æ•—:', error);
            }
        });
        elements.brightnessSlider.addEventListener('input', (event) => {
            const brightness = parseInt(event.target.value, 10);
            if (!gameCharacteristic) return;
            try {
                // ä½¿ç”¨æ–°çš„æŒ‡ä»¤ä»£ç¢¼ 0x09
                let data = new Uint8Array([COMMANDS.SET_BRIGHTNESS, brightness]);
                gameCharacteristic.writeValueWithoutResponse(data);
            } catch(error) {
                console.error('äº®åº¦æŒ‡ä»¤ç™¼é€å¤±æ•—:', error);
            }
        });

        elements.buttons.selectTetris.addEventListener('click', () => selectGame(GAMES.TETRIS));
        elements.buttons.selectSnake.addEventListener('click', () => selectGame(GAMES.SNAKE));
        elements.buttons.selectDino.addEventListener('click', () => selectGame(GAMES.DINO));
        
        function selectGame(gameId) {
            sendCommand(COMMANDS.SELECT_GAME, gameId);
            elements.gameSelection.style.display = 'none';
            elements.gamepadBody.style.display = 'flex';
            elements.scoreBoard.style.display = 'block';
            
            elements.actionButtons.innerHTML = `
                <button class="button" id="btn-y" title="é ç•™ (Y)">Y</button>
                <button class="button" id="btn-x" title="é ç•™ (X)">X</button>
                <button class="button" id="btn-b" title="é‡æ–°é–‹å§‹ (B)">B</button>
                <button class="button" id="btn-a" title="ä¸»è¦å‹•ä½œ">A</button>`;
            
            elements.buttons.a = document.getElementById('btn-a');
            elements.buttons.b = document.getElementById('btn-b');
            elements.buttons.x = document.getElementById('btn-x');
            elements.buttons.y = document.getElementById('btn-y');
            
            elements.buttons.a.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.ACTION_A); });
            elements.buttons.b.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.ACTION_B); });

            if (gameId === GAMES.TETRIS) {
                elements.dPad.style.display = 'block';
                elements.actionButtons.style.display = 'block';
                elements.pauseBtn.style.display = 'block';
                elements.returnBtn.style.display = 'block';
                elements.buttons.a.title = "æ—‹è½‰ (Space)";
                elements.buttons.x.title = "åŠ é€Ÿä¸‹é™ (X)";
                elements.buttons.x.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.DOWN); });
            } else if (gameId === GAMES.SNAKE) {
                elements.dPad.style.display = 'block';
                elements.pauseBtn.style.display = 'block';
                elements.returnBtn.style.display = 'block';
                elements.actionButtons.style.display = 'block';
                elements.buttons.b.title = "è¿”å›é¸å–®/é‡æ–°é–‹å§‹ (B)";
                elements.buttons.a.style.display = 'none';
                elements.buttons.x.style.display = 'none';
                elements.buttons.y.style.display = 'none';
            } else if (gameId === GAMES.DINO) {
                elements.dPad.style.display = 'block';
                elements.actionButtons.style.display = 'block';
                elements.pauseBtn.style.display = 'block';
                elements.returnBtn.style.display = 'block';
                elements.buttons.a.title = "è·³èº (A/Space)";
                elements.buttons.b.title = "é‡æ–°é–‹å§‹ (B)";
                elements.buttons.x.style.display = 'none';
                elements.buttons.y.style.display = 'none';
            }
        }
        
        elements.returnBtn.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.RETURN_MENU); });
        elements.pauseBtn.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.PAUSE); });
        elements.buttons.up.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.UP); });
        elements.buttons.down.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.DOWN); });
        elements.buttons.left.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.LEFT); });
        elements.buttons.right.addEventListener('pointerdown', e => { e.preventDefault(); sendCommand(COMMANDS.RIGHT); });

        function handleGameStateUpdate(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const stateString = decoder.decode(value);
            const [score, level, lines] = stateString.split(',');
            
            if (score === 'MENU') {
                elements.gamepadBody.style.display = 'none';
                elements.scoreBoard.style.display = 'none';
                elements.gameSelection.style.display = 'flex';
                elements.status.textContent = 'âœ… è«‹é¸æ“‡ä¸€å€‹éŠæˆ²ã€‚';
                elements.returnBtn.style.display = 'none';
                elements.pauseBtn.style.display = 'none';
                return; 
            }
            
            elements.scoreDisplay.textContent = score;
            elements.levelDisplay.textContent = level;
            const linesSpan = elements.linesDisplay.parentNode;
            if (lines === '-') {
                linesSpan.style.display = 'none';
            } else {
                linesSpan.style.display = 'inline';
                elements.linesDisplay.textContent = lines;
            }
        }
    </script>
</body>
</html>