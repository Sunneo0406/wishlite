<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>捷綠盟碳排觀察器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .apexcharts-canvas {
            margin: 0 auto;
        }

        .button-active {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            transform: translateY(2px);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto max-w-4xl bg-white p-8 rounded-2xl shadow-xl space-y-8">

        <div class="flex items-center justify-center mb-8 p-4 rounded-lg bg-[#F5DEB3] shadow-md"">
            <img src="img/jlm.png" alt="公司Logo" class="w-12 h-12 mr-4">
            <h1 class="text-3xl font-bold text-gray-800">捷綠盟用電總覽與查詢</h1>
        </div>

        <div id="dashboard-charts" class="flex flex-col md:flex-row justify-center items-center space-y-8 md:space-y-0 md:space-x-8">
            <div id="kwh-chart" class="w-full md:w-1/2 bg-gray-50 rounded-xl p-4 shadow-inner"></div>
            <div id="co2e-chart" class="w-full md:w-1/2 bg-gray-50 rounded-xl p-4 shadow-inner"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">班次查詢</h2>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="day_shift_btn" onclick="fetchShiftData('day_shift', this)" class="flex-grow py-3 px-6 bg-blue-500 text-white font-bold rounded-full hover:bg-blue-600 transition-colors">前日早班</button>
                    <button id="night_shift_btn" onclick="fetchShiftData('night_shift', this)" class="flex-grow py-3 px-6 bg-blue-500 text-white font-bold rounded-full hover:bg-blue-600 transition-colors">前日晚班</button>
                    <button id="since_morning_btn" onclick="fetchShiftData('since_morning', this)" class="flex-grow py-3 px-6 bg-blue-500 text-white font-bold rounded-full hover:bg-blue-600 transition-colors">今日早班至今</button>
                </div>
                <div class="flex flex-col space-y-4">
                    <label for="tableName" class="block text-gray-700 font-medium">選擇電錶:</label>
                    <select id="tableName" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="冰水機">冰水機</option>
                        <option value="空壓機">空壓機</option>
                        <option value="120型">120型</option>
                        <option value="sensor_data1">第一集電箱</option>
                        <option value="sensor_data2">第二集電箱</option>
                        <option value="破碎機(220V)">破碎機(220V)</option>
                        <option value="雕刻機">雕刻機</option>
                        <option value="攪拌機A">攪拌機A</option>
                    </select>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">自訂區間查詢</h2>
                <div class="space-y-4">
                    <label for="startTime" class="block text-gray-700 font-medium">開始時間:</label>
                    <input type="datetime-local" id="startTime" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <label for="endTime" class="block text-gray-700 font-medium">結束時間:</label>
                    <input type="datetime-local" id="endTime" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="fetchCustomPeriodData(this)" class="mt-6 w-full py-3 px-6 bg-blue-500 text-white font-bold rounded-full hover:bg-blue-600 transition-colors">查詢自訂區間</button>
            </div>
        </div>

        <div class="bg-blue-50 p-6 rounded-2xl shadow-inner border border-blue-200">
            <h2 class="text-xl font-semibold text-blue-700 mb-2">查詢結果:</h2>
            <div id="response-display" class="text-2xl text-gray-800 font-bold">請點擊按鈕進行查詢...</div>
            <div id="co2e-display" class="text-2xl text-gray-600 mt-2"></div>
            <div id="query-time-display" class="text-sm text-gray-500 mt-2"></div>
        </div>
    </div>

    <script>
        const CLOUD_RUN_URL = 'https://jlm-co2e-db-connect-221081318298.asia-east1.run.app';
        const TAIPOWER_CO2E_FACTOR = 0.495;

        let kwhChart, co2eChart;

        function initCharts() {
            const kwhOptions = {
                series: [0],
                chart: {
                    height: 350,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        hollow: { size: '70%' },
                        dataLabels: {
                            show: true,
                            name: {
                                offsetY: -15,
                                show: true,
                                color: '#888',
                                fontSize: '40px',
                                formatter: () => '總用電量'
                            },
                            value: {
                                offsetY: 5,
                                color: '#1f2937',
                                fontSize: '30px',
                                show: true,
                                formatter: (val) => [`${parseFloat(val).toFixed(2)}`, `kWh`]
                            }
                        }
                    }
                },
                fill: { colors: ['#3B82F6'] },
                labels: ['總用電量']
            };

            const co2eOptions = {
                series: [0],
                chart: {
                    height: 350,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        hollow: { size: '70%' },
                        dataLabels: {
                            show: true,
                            name: {
                                offsetY: -15,
                                show: true,
                                color: '#888',
                                fontSize: '40px',
                                formatter: () => '總碳排量'
                            },
                            value: {
                                offsetY: 5,
                                color: '#1f2937',
                                fontSize: '30px',
                                show: true,
                                formatter: (val) => [`${parseFloat(val).toFixed(2)}`, `Kg`]
                            }
                        }
                    }
                },
                fill: { colors: ['#10B981'] },
                labels: ['總碳排量']
            };

            kwhChart = new ApexCharts(document.querySelector("#kwh-chart"), kwhOptions);
            co2eChart = new ApexCharts(document.querySelector("#co2e-chart"), co2eOptions);

            kwhChart.render();
            co2eChart.render();
        }

        function setActiveButton(activeButton) {
            const allButtons = document.querySelectorAll('.flex-grow');
            allButtons.forEach(button => button.classList.remove('button-active'));
            if (activeButton) {
                activeButton.classList.add('button-active');
            }
        }

        async function fetchTotalData() {
            try {
                const response = await fetch(`${CLOUD_RUN_URL}/api/get_total_latest_kwh`);
                const result = await response.json();
                if (response.ok) {
                    const totalKwh = result.total_kwh;
                    const totalCo2e = totalKwh * TAIPOWER_CO2E_FACTOR;
                    kwhChart.updateSeries([totalKwh]);
                    co2eChart.updateSeries([totalCo2e]);
                    console.log('總數據更新成功:', result);
                } else {
                    console.error('API 錯誤:', result);
                }
            } catch (error) {
                console.error('連線錯誤:', error);
            }
        }

        // 處理班次查詢
        async function fetchShiftData(shiftType, buttonElement) {
            setActiveButton(buttonElement);
            const startTime = new Date();
            const tableName = document.getElementById('tableName').value;
            const responseDisplay = document.getElementById('response-display');
            const co2eDisplay = document.getElementById('co2e-display');
            const queryTimeDisplay = document.getElementById('query-time-display');

            const titleMap = {
                'day_shift': '前日早班',
                'night_shift': '前日晚班',
                'since_morning': '今日早班至今'
            };
            const title = titleMap[shiftType] || '查詢';

            const url = `${CLOUD_RUN_URL}/api/get_watt_hours/${shiftType}/${tableName}`;

            responseDisplay.innerHTML = `<strong>正在查詢 ${tableName} 的 ${title} 資料...</strong>`;
            co2eDisplay.innerHTML = '';
            queryTimeDisplay.innerHTML = '';

            try {
                const response = await fetch(url);
                const result = await response.json();
                const endTime = new Date();
                const elapsedTime = endTime - startTime;

                if (response.ok) {
                    const kwh = result.kilo_watt_hours;
                    const co2e = kwh * TAIPOWER_CO2E_FACTOR;
                    responseDisplay.innerHTML = `<strong>${tableName}</strong><br><strong>${title}</strong> 共使用 ${kwh.toFixed(2)} 度電`;
                    co2eDisplay.innerHTML = `<strong>${title}產生</strong><span style="color: red;font-size: 40px;"> ${co2e.toFixed(2)} </span>公斤碳排`;
                    queryTimeDisplay.innerHTML = `查詢完成，耗時 ${elapsedTime} 毫秒`;
                    console.log('單一電錶查詢成功:', result);
                } else {
                    responseDisplay.innerHTML = `<strong class="text-red-500">錯誤：</strong> ${result.detail || '未知的錯誤'}`;
                    co2eDisplay.innerHTML = '';
                    queryTimeDisplay.innerHTML = `查詢失敗，耗時 ${elapsedTime} 毫秒`;
                    console.error('API 錯誤:', result);
                }
            } catch (error) {
                const endTime = new Date();
                const elapsedTime = endTime - startTime;
                responseDisplay.innerHTML = `<strong class="text-red-500">連線失敗或錯誤：</strong> ${error.message}`;
                co2eDisplay.innerHTML = '';
                queryTimeDisplay.innerHTML = `查詢失敗，耗時 ${elapsedTime} 毫秒`;
                console.error('連線錯誤:', error);
            }
        }

        // 處理自訂區間查詢
        async function fetchCustomPeriodData(buttonElement) {
            setActiveButton(buttonElement);
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const tableName = document.getElementById('tableName').value;
            const responseDisplay = document.getElementById('response-display');
            const co2eDisplay = document.getElementById('co2e-display');
            const queryTimeDisplay = document.getElementById('query-time-display');

            if (!startTime || !endTime) {
                responseDisplay.innerHTML = '<strong class="text-red-500">錯誤：請選擇起始和結束時間。</strong>';
                co2eDisplay.innerHTML = '';
                return;
            }
            // 修改後，將 ISO 8601 字串的最後 5 個字元（.000Z）移除
            const startISO = new Date(startTime).toISOString();
            const endISO = new Date(endTime).toISOString();

            // 正確地呼叫後端自訂區間的 API
            const url = `${CLOUD_RUN_URL}/api/get_watt_hours/custom/${tableName}?start_iso=${startISO}&end_iso=${endISO}`;

            responseDisplay.innerHTML = `<strong>正在查詢 ${tableName} 的自訂區間資料...</strong>`;
            co2eDisplay.innerHTML = '';
            queryTimeDisplay.innerHTML = '';

            try {
                const response = await fetch(url);
                const result = await response.json();
                const endTimeRequest = new Date();
                const elapsedTime = endTimeRequest - new Date(startTime);

                if (response.ok) {
                    const kwh = result.kilo_watt_hours;
                    const co2e = kwh * TAIPOWER_CO2E_FACTOR;
                    responseDisplay.innerHTML = `<strong>${tableName}</strong><br><strong>自訂區間</strong> 查詢結果: ${kwh.toFixed(2)} kWh`;
                    co2eDisplay.innerHTML = `本次查詢共產生 <span style="color: red;font-size: 40px;">${co2e.toFixed(2)}</span> 公斤碳排`;
                    queryTimeDisplay.innerHTML = `查詢完成，耗時 ${elapsedTime} 毫秒`;
                    console.log('自訂區間查詢成功:', result);
                } else {
                    responseDisplay.innerHTML = `<strong class="text-red-500">錯誤：</strong> ${result.detail || '未知的錯誤'}`;
                    co2eDisplay.innerHTML = '';
                    queryTimeDisplay.innerHTML = `查詢失敗，耗時 ${elapsedTime} 毫秒`;
                    console.error('API 錯誤:', result);
                }
            } catch (error) {
                const endTimeRequest = new Date();
                const elapsedTime = endTimeRequest - new Date(startTime);
                responseDisplay.innerHTML = `<strong class="text-red-500">連線失敗或錯誤：</strong> ${error.message}`;
                co2eDisplay.innerHTML = '';
                queryTimeDisplay.innerHTML = `查詢失敗，耗時 ${elapsedTime} 毫秒`;
                console.error('連線錯誤:', error);
            }
        }

        window.onload = function () {
            initCharts();
            fetchTotalData();
        };
    </script>
</body>
</html>